
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>System Dashboard</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen-Sans, Ubuntu, Cantarell, "Helvetica Neue", sans-serif;
      background-color: #f4f7f9;
      color: #333;
      margin: 0;
      padding: 20px;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background-color: #ffffff;
      padding: 20px 30px;
      border-radius: 8px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    }
    h1 { color: #2c3e50; text-align: center; }

    #system-summary {
      display: flex;
      justify-content: space-around;
      flex-wrap: wrap;
      gap: 15px;
      padding: 15px;
      background-color: #f8f9fa;
      border-radius: 6px;
      margin-bottom: 25px;
      border: 1px solid #e0e0e0;
    }
    .summary-box { flex: 1; min-width: 220px; text-align: center; }
    .summary-title { font-size: 1em; color: #6c757d; margin-bottom: 5px; }
    .summary-value { font-size: 1em; color: #343a40; font-weight: 500; line-height: 1.6; }
    .summary-value[data-type="cpu"].high { color: #dc3545; }
    .summary-value[data-type="cpu"].medium { color: #ffc107; }
    .summary-value[data-type="cpu"].low { color: #28a745; }

    #controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 15px 0;
    }
    #search {
      padding: 6px 10px;
      font-size: 1em;
      border: 1px solid #ccc;
      border-radius: 4px;
      width: 250px;
    }

    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border-bottom: 1px solid #e0e0e0; padding: 12px 15px; text-align: left; }
    thead tr { background-color: #4a6fa5; color: #ffffff; cursor: pointer; }
    th { font-weight: 600; }
    tbody tr:nth-child(even) { background-color: #f8f9fa; }
    tbody tr:hover { background-color: #e9ecef; }
    .loading { text-align: center; padding: 20px; font-size: 1.2em; color: #777; }
  </style>
</head>
<body>
  <div class="container">
    <h1>📊 시스템 대시보드</h1>
    
    <div id="system-summary">
      <div class="summary-box">
        <div class="summary-title">⚙️ CPU 사용률</div>
        <div class="summary-value" id="summary-cpu" data-type="cpu">Loading...</div>
      </div>
      <div class="summary-box">
        <div class="summary-title">🧠 메모리 사용량</div>
        <div class="summary-value" id="summary-mem">
          <div>총: -</div>
          <div>사용: -</div>
          <div>남음: -</div>
          <div>버퍼/캐시: -</div>
        </div>
      </div>
      <div class="summary-box">
        <div class="summary-title">📋 작업(Task)</div>
        <div class="summary-value" id="summary-tasks">
          <div>전체: -</div>
          <div>실행 중: -</div>
          <div>슬립: -</div>
          <div>좀비: -</div>
        </div>
      </div>
      <div class="summary-box">
        <div class="summary-title">📊 부하 평균</div>
        <div class="summary-value" id="summary-load">
          <div>1분: -</div>
          <div>5분: -</div>
          <div>15분: -</div>
        </div>
      </div>
    </div>

    <div id="controls">
      <h2>💻 프로세스 목록</h2>
      <input type="text" id="search" placeholder="🔍 사용자 또는 명령어 검색..." />
    </div>

    <table>
      <thead>
        <tr>
          <th data-key="pid">PID ⬍</th>
          <th data-key="user">User ⬍</th>
          <th data-key="cpu">CPU (%) ⬍</th>
          <th data-key="mem">Memory (%) ⬍</th>
          <th data-key="comm">Command ⬍</th>
        </tr>
      </thead>
      <tbody id="process-body">
        <tr>
          <td colspan="5" class="loading">목록을 불러오는 중...</td>
        </tr>
      </tbody>
    </table>
  </div>


  <script>
    
    document.addEventListener('DOMContentLoaded', () => {
      const tableBody = document.getElementById('process-body');
      const summaryCpu = document.getElementById('summary-cpu');
      const summaryMem = document.getElementById('summary-mem');
      const summaryTasks = document.getElementById('summary-tasks');
      const summaryLoad = document.getElementById('summary-load');
      const searchInput = document.getElementById('search');
      const headers = document.querySelectorAll("thead th");

      let processes = [];
      let sortKey = "cpu";
      let sortOrder = "desc";

      const renderTable = () => {
        const query = searchInput.value.toLowerCase();
        let filtered = processes.filter(proc =>
          proc.user.toLowerCase().includes(query) ||
          proc.comm.toLowerCase().includes(query)
        );

        filtered.sort((a, b) => {
          if (a[sortKey] < b[sortKey]) return sortOrder === "asc" ? -1 : 1;
          if (a[sortKey] > b[sortKey]) return sortOrder === "asc" ? 1 : -1;
          return 0;
        });

        tableBody.innerHTML = '';
        if (filtered.length === 0) {
          tableBody.innerHTML = '<tr><td colspan="5" class="loading">검색 결과 없음</td></tr>';
          return;
        }
        filtered.forEach(proc => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${proc.pid}</td>
            <td>${proc.user}</td>
            <td>${proc.cpu.toFixed(2)}</td>
            <td>${proc.mem.toFixed(2)}</td>
            <td>${proc.comm}</td>
          `;
          tableBody.appendChild(row);
        });
      };

      const fetchSystemStatus = async () => {
        try {
          const response = await fetch('/system/proc');
          if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

          const { summary, processes: data } = await response.json();
          processes = data;

          // CPU
          summaryCpu.textContent = summary.cpuUsage;
          const cpuPercent = parseFloat(summary.cpuUsage.split(',')[0]);
          if (cpuPercent > 50) {
            summaryCpu.classList.add("high");
          } else if (cpuPercent > 20) {
            summaryCpu.classList.add("medium");
          } else {
            summaryCpu.classList.add("low");
          }

          // Memory
          const [total, free, used, buffCache] = summary.memUsage.split(',').map(s => s.trim());
          summaryMem.innerHTML = `
            <div>총: ${total}</div>
            <div>사용: ${used}</div>
            <div>남음: ${free}</div>
            <div>버퍼/캐시: ${buffCache}</div>
          `;

          // Tasks
          const taskLines = summary.tasks.split(',').map(s => s.trim());
          summaryTasks.innerHTML = `
            <div>전체: ${taskLines[0]}</div>
            <div>실행 중: ${taskLines[1]}</div>
            <div>슬립: ${taskLines[2]}</div>
            <div>좀비: ${taskLines[4]}</div>
          `;

          // Load Average
          const [load1, load5, load15] = summary.loadAverage.split(',').map(s => s.trim());
          summaryLoad.innerHTML = `
            <div>1분: ${load1}</div>
            <div>5분: ${load5}</div>
            <div>15분: ${load15}</div>
          `;

          renderTable();
        } catch (error) {
          console.error("시스템 상태를 가져오는 데 실패했습니다:", error);
          tableBody.innerHTML = `<tr><td colspan="5" class="loading" style="color: red;">데이터 로딩 실패!</td></tr>`;
          summaryCpu.textContent = summaryMem.textContent = summaryTasks.textContent = summaryLoad.textContent = 'Error';
        }
      };

      searchInput.addEventListener('input', renderTable);

      headers.forEach(header => {
        header.addEventListener('click', () => {
          const key = header.dataset.key;
          if (sortKey === key) {
            sortOrder = sortOrder === "asc" ? "desc" : "asc";
          } else {
            sortKey = key;
            sortOrder = "asc";
          }
          renderTable();
        });
      });

      fetchSystemStatus();
      setInterval(fetchSystemStatus, 5000);
    });
  </script>
</body>
</html>
