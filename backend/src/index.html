
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>System Dashboard</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen-Sans, Ubuntu, Cantarell, "Helvetica Neue", sans-serif;
      background-color: #f4f7f9;
      color: #333;
      margin: 0;
      padding: 20px;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background-color: #ffffff;
      padding: 20px 30px;
      border-radius: 8px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    }
    h1 { color: #2c3e50; text-align: center; }

    #system-summary {
      display: flex;
      justify-content: space-around;
      flex-wrap: wrap;
      gap: 15px;
      padding: 15px;
      background-color: #f8f9fa;
      border-radius: 6px;
      margin-bottom: 25px;
      border: 1px solid #e0e0e0;
    }
    .summary-box { flex: 1; min-width: 220px; text-align: center; }
    .summary-title { font-size: 1em; color: #6c757d; margin-bottom: 5px; }
    .summary-value { font-size: 1em; color: #343a40; font-weight: 500; line-height: 1.6; }

    #controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 15px 0;
    }
    #search {
      padding: 6px 10px;
      font-size: 1em;
      border: 1px solid #ccc;
      border-radius: 4px;
      width: 250px;
    }

    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border-bottom: 1px solid #e0e0e0; padding: 12px 15px; text-align: left; }
    thead tr { background-color: #4a6fa5; color: #ffffff; cursor: pointer; }
    th { font-weight: 600; }
    tbody tr:nth-child(even) { background-color: #f8f9fa; }
    tbody tr:hover { background-color: #e9ecef; }
    .loading { text-align: center; padding: 20px; font-size: 1.2em; color: #777; }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <div class="container">
    <h1>📊 시스템 대시보드</h1>
    
    <div id="system-summary">
      <div class="summary-box">
        <div class="summary-title">⚙️ CPU 사용률</div>
        <canvas id="cpuChart" width="160" height="160"></canvas>
        <div id="cpuTotal" style="margin-top:8px; font-weight:500;">Loading...</div>
      </div>
      <div class="summary-box">
        <div class="summary-title">🧠 메모리 사용량</div>
        <canvas id="memChart" width="200" height="150"></canvas>
      </div>
      <div class="summary-box">
        <div class="summary-title">📋 작업(Task)</div>
        <canvas id="taskChart" width="200" height="150"></canvas>
      </div>
      <div class="summary-box">
        <div class="summary-title">📊 부하 평균</div>
        <canvas id="loadChart" width="200" height="150"></canvas>
      </div>
    </div>

    <div id="controls">
      <h2>💻 프로세스 목록</h2>
      <input type="text" id="search" placeholder="🔍 사용자 또는 명령어 검색..." />
    </div>

    <table>
      <thead>
        <tr>
          <th data-key="pid">PID ⬍</th>
          <th data-key="user">User ⬍</th>
          <th data-key="cpu">CPU (%) ⬍</th>
          <th data-key="mem">Memory (%) ⬍</th>
          <th data-key="comm">Command ⬍</th>
        </tr>
      </thead>
      <tbody id="process-body">
        <tr>
          <td colspan="5" class="loading">목록을 불러오는 중...</td>
        </tr>
      </tbody>
    </table>
  </div>


  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const tableBody = document.getElementById('process-body');
      const searchInput = document.getElementById('search');
      const headers = document.querySelectorAll("thead th");

      let processes = [];
      let sortKey = "cpu";
      let sortOrder = "desc";
      let cpuChart, memChart, taskChart, loadChart;

      const renderTable = () => {
        const query = searchInput.value.toLowerCase();
        let filtered = processes.filter(proc =>
          proc.user.toLowerCase().includes(query) ||
          proc.comm.toLowerCase().includes(query)
        );

        filtered.sort((a, b) => {
          if (a[sortKey] < b[sortKey]) return sortOrder === "asc" ? -1 : 1;
          if (a[sortKey] > b[sortKey]) return sortOrder === "asc" ? 1 : -1;
          return 0;
        });

        tableBody.innerHTML = '';
        if (filtered.length === 0) {
          tableBody.innerHTML = '<tr><td colspan="5" class="loading">검색 결과 없음</td></tr>';
          return;
        }
        filtered.forEach(proc => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${proc.pid}</td>
            <td>${proc.user}</td>
            <td>${proc.cpu.toFixed(2)}</td>
            <td>${proc.mem.toFixed(2)}</td>
            <td>${proc.comm}</td>
          `;
          tableBody.appendChild(row);
        });
      };

      function parseCpuUsage(raw){
        const stats = {};
        raw.split(",").forEach(part => {
            const [value, key] = part.trim().split(" ");
            if(key) stats[key] = parseFloat(value);
        });
        return stats;
      }

      function renderCpuChart(rawCpuUsage){
        const stats = parseCpuUsage(rawCpuUsage);
        const totalUsage = 100 - (stats["id"] || 0);
        const ctx = document.getElementById("cpuChart").getContext("2d");

        const data = {
            labels: ["User", "System", "Nice", "IOwait", "IRQ", "SoftIRQ", "Steal", "Idle"],
            datasets: [{
                data: [
                    stats["us"] || 0,
                    stats["sy"] || 0,
                    stats["ni"] || 0,
                    stats["wa"] || 0,
                    stats["hi"] || 0,
                    stats["si"] || 0,
                    stats["st"] || 0,
                    stats["id"] || 0
                ],
                backgroundColor: [
                    "#4CAF50", // User
                    "#F44336", // System
                    "#FF9800", // Nice
                    "#2196F3", // IOwait
                    "#9C27B0", // IRQ
                    "#00BCD4", // SoftIRQ
                    "#795548", // Steal
                    "#E0E0E0"  // Idle
                ],
            }]
        };

        if(cpuChart){
            cpuChart.data = data;
            cpuChart.update();
        }else{
            cpuChart = new Chart(ctx, {
                type: "doughnut",
                data,
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: "bottom" }
                    }
                }
            });
        }

        document.getElementById("cpuTotal").textContent = `총 사용률: ${totalUsage.toFixed(1)}%`;
      }

      function renderMemChart(memSummary){
        const ctx = document.getElementById("memChart").getContext("2d");
        const [total, free, used, buffCache] = memSummary.split(',').map(s => s.trim());

        const data = {
            labels: ["전체", "사용", "남음", "버퍼/캐시"],
            datasets: [{
                label: "메모리 (MB)",
                data: [(parseFloat(total) / 1024).toFixed(2), 
                       (parseFloat(used) / 1024).toFixed(2), 
                       (parseFloat(free) / 1024).toFixed(2), 
                       (parseFloat(buffCache) / 1024).toFixed(2)],
                backgroundColor: ["#23A4DB", "#F44336", "#4CAF50", "#FF9800"],
            }]
        };

        if (memChart) {
            memChart.data = data;
            memChart.update();
        } else {
            memChart = new Chart(ctx, { type: "bar", data });
        }
      }

      function renderTaskChart(taskSummary){
        const ctx = document.getElementById("taskChart").getContext("2d");
        const [total, running, sleeping, stopped, zombie] = taskSummary.split(',').map(s => s.trim());

        const data = {
            labels: ["실행", "슬립", "좀비"],
            datasets: [{
                label: "작업(Task) 개수",  
                data: [parseFloat(running), parseFloat(sleeping), parseFloat(zombie)],
                backgroundColor: ["#2196F3", "#FFC107", "#9C27B0"]
            }]
        };

        if (taskChart) {
            taskChart.data = data;
            taskChart.update();
        } else {
            taskChart = new Chart(ctx, { type: "bar", data });
        }
      }

      function renderLoadChart(loadSummary) {
        const ctx = document.getElementById("loadChart").getContext("2d");
        const [load1, load5, load15] = loadSummary.split(',').map(s => s.trim());

        const data = {
        labels: ["1분", "5분", "15분"],
        datasets: [{
            label: "부하 평균 수",
            data: [parseFloat(load1), parseFloat(load5), parseFloat(load15)],
            backgroundColor: ["#00BCD4", "#8BC34A", "#FF5722"]
        }]
        };

        if (loadChart) {
            loadChart.data = data;
            loadChart.update();
        } else {
            loadChart = new Chart(ctx, { type: "bar", data });
        }
      }

      const fetchSystemStatus = async () => {
        try {
          const response = await fetch('/system/proc');
          if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

          const { summary, processes: data } = await response.json();
          processes = data;

          // CPU
          renderCpuChart(summary.cpuUsage);

          // Memory
          renderMemChart(summary.memUsage);

          // Tasks
          renderTaskChart(summary.tasks);

          // Load Average
          renderLoadChart(summary.loadAverage);

          renderTable();
        } catch (error) {
          console.error("시스템 상태를 가져오는 데 실패했습니다:", error);
          tableBody.innerHTML = `<tr><td colspan="5" class="loading" style="color: red;">데이터 로딩 실패!</td></tr>`;
        }
      };

      searchInput.addEventListener('input', renderTable);

      headers.forEach(header => {
        header.addEventListener('click', () => {
          const key = header.dataset.key;
          if (sortKey === key) {
            sortOrder = sortOrder === "asc" ? "desc" : "asc";
          } else {
            sortKey = key;
            sortOrder = "asc";
          }
          renderTable();
        });
      });

      fetchSystemStatus();
      setInterval(fetchSystemStatus, 5000);
    });
  </script>
</body>
</html>
